#############################################################################################################
### CONFIGURATION GENERATED BY THE RATOS CONFIGURATOR
### Everything below [include RatOS.cfg] will override default RatOS behavior
#############################################################################################################
[include RatOS.cfg]

#############################################################################################################
### MACRO CONFIGURATION
### Configure the behavior of RatOS macros
### See: https://os.ratrig.com/docs/configuration/macros
#############################################################################################################
[gcode_macro RatOS]
variable_relative_extrusion: False
variable_preheat_extruder: False
variable_preheat_extruder_temp: 220
variable_calibrate_bed_mesh: False
variable_bed_mesh_profile: "default"
variable_nozzle_priming: "primeblob"
variable_start_print_park_in: "front"
variable_start_print_park_z_height: 50
variable_end_print_park_in: "back"
variable_end_print_park_z_hop: 10
variable_pause_print_park_in: "front"
variable_macro_travel_speed: 200
variable_macro_travel_accel: 3000
variable_macro_z_speed: 15
variable_filament_load_temp: 235        # temperature to heat up hotend for filament loading, default is 235
variable_filament_unload_temp: 185      # temperature to heat up hotend for filament un-loading, default is 185
variable_filament_load_min_temp: 190    # minimum hotend set temperature allowed in filament load macro, default is 190
variable_nozzle_purge_length: 200       # filament extrude amount during load sequenc, hotend purge from old filament, default is 200
variable_nozzle_purge_speed: 300        # filament extrude speed in mm/min adjust this value lower if flow is too high and extruder skips during loading, default is 300
variable_unload_distance: 65            # filament retract distance for unload procedure. this length shall be long enough to extract the filament above the drive gears
variable_park_retraction: 1             # edit your retraction amount for parking, default is 1
variable_adaptive_mesh: False

#############################################################################################################
### USER OVERRIDES & CUSTOM CONFIGURATION
### Anything custom you want to add, or RatOS configuration you want to override, do it here.
### This section is pre-populated with the most common settings you may want to change.
### See: https://os.ratrig.com/docs/configuration/includes-and-overrides
###
### It is recommended that you follow these steps to properly calibrate your printer:
### 0) Sanity check and PID Tuning: https://www.klipper3d.org/Config_checks.html
### 1) Z-offset calibration: https://www.klipper3d.org/Probe_Calibrate.html#calibrating-probe-z-offset
### 2) Pressure Advance: https://www.klipper3d.org/Pressure_Advance.html
### 3) Skew Correction: https://www.klipper3d.org/Skew_Correction.html
### 4) Resonance Compensation: https://www.klipper3d.org/Resonance_Compensation.html
### RatOS has dedicated macro's to generate shaper graphs for deeper analysis (requires accelerometer).
### Use GENERATE_SHAPER_GRAPHS to generate the resonance graphs for analysing and manually entering 
### input shaper configuration.
### You can run SHAPER_CALIBRATE to automatically calibrate your input shaper configuration, if you just want
### to get started.
### Additionally, you can use the Realtime Analysis Tool to analyze your printer's performance in real-time.
### Read more about klipper here: https://www.klipper3d.org/Overview.html
#############################################################################################################

#-------------------------------------------------- RatOS ---------------------------------------------------
# RatOS
#------------------------------------------------------------------------------------------------------------
[ratos]
allow_unsupported_slicer_versions: True

#--------------------------------------------- exclude Objects ----------------------------------------------
# Enable object exclusion
#------------------------------------------------------------------------------------------------------------
[exclude_object]

#-------------------------------------------------- Arcs ----------------------------------------------------
# Enable arcs support
#------------------------------------------------------------------------------------------------------------
[gcode_arcs]
resolution: 0.1

#---------------------------------------------------- X -----------------------------------------------------
# The X axis motor moves the print head left and right.
#------------------------------------------------------------------------------------------------------------
[stepper_x]
dir_pin: !x_dir_pin                # Remove ! in front of pin name to reverse the direction of stepper_x
rotation_distance: 40              # 40 for 20 tooth 2GT pulleys, 32 for 16 tooth 2GT pulleys
homing_speed: 50
position_min: -3
position_max: 180
position_endstop: -3

#---------------------------------------------------- Y -----------------------------------------------------
# The Y axis motor moves the print bed forward and backward.
#------------------------------------------------------------------------------------------------------------
[stepper_y]
dir_pin: y_dir_pin                 # Remove ! in front of pin name to reverse the direction of stepper_y
rotation_distance: 40              # 40 for 20 tooth 2GT pulleys, 32 for 16 tooth 2GT pulleys
homing_speed: 50
position_min: -4
position_max: 180
position_endstop: -4

#---------------------------------------------------- Z -----------------------------------------------------
# The Z axis motor moves the print head up and down.
#------------------------------------------------------------------------------------------------------------
[stepper_z]
dir_pin: z0_dir_pin                # Remove ! in front of pin name to reverse the direction of stepper_z
rotation_distance: 8               # 4 for TR8*4 lead screws
homing_speed: 10
position_min: -5
position_max: 180

#------------------------------------------------- EXTRUDER -------------------------------------------------
# The extruder motor used for your toolhead
#------------------------------------------------------------------------------------------------------------
[extruder]
dir_pin: toolboard_t0:e_dir_pin    # Remove ! in front of pin name to reverse the direction of extruder
rotation_distance: 4.65778         # Orbiter 2 default
pressure_advance: 0.0575           # Check https://www.klipper3d.org/Pressure_Advance.html for pressure advance tuning.
#control: pid
#pid_kp: 21.673
#pid_ki: 1.338
#pid_kd: 87.776

#--------------------------------------------- FILAMENT SENSOR ----------------------------------------------
# Orbiter 2 Smart Sensor
#------------------------------------------------------------------------------------------------------------
[filament_switch_sensor toolhead_filament_sensor_t0]
pause_on_runout: False
event_delay: 2.5
pause_delay: 0.1
switch_pin: ^toolboard_t0:PB4
runout_gcode:
	_ON_TOOLHEAD_FILAMENT_SENSOR_RUNOUT TOOLHEAD=0
insert_gcode:
	_ON_TOOLHEAD_FILAMENT_SENSOR_INSERT TOOLHEAD=0
  
[gcode_button toolhead_filament_sensor_button_t0]
pin: ^!toolboard_t0:PB3
release_gcode:    
    {% if (printer.print_stats.state == "printing") %}
        _ON_TOOLHEAD_FILAMENT_SENSOR_CLOG TOOLHEAD=0
    {% else %}
        _ON_FILAMENT_SENSOR_BUTTON_PRESSED TOOLHEAD=0
    {% endif %}
press_gcode:

#-------------------------------------------------- PROBE ---------------------------------------------------
# Probe configuration
#------------------------------------------------------------------------------------------------------------
[probe]
#z_offset: 0.0                     # Will be commented out after a successful PROBE_CALIBRATE and SAVE_CONFIG
pin: ^toolboard_t0:probe_pin       # For NPN NC probes such as the Super Pinda / Vinda / SupCR / Decoprobe probes.
#pin: ^!toolboard_t0:probe_pin     # NPN NO (refer to the specs of your probe)
#pin: toolboard_t0:probe_pin       # PNP NO (refer to the specs of your probe)
#pin: !toolboard_t0:probe_pin      # PNP NC (refer to the specs of your probe)

#[mcu eddy]
#serial: /dev/serial/by-id/usb-Klipper_rp2040_eddy-if00
#restart_method: command

#[temperature_sensor btt_eddy_mcu]
#sensor_type: temperature_mcu # Sets the type of sensor for Klipper to read
#sensor_mcu: eddy # Sets the MCU of the eddy probe tempereature sensor
#min_temp: 10 # Sets the minimum tempereature for eddys tempereature sensor to operate
#max_temp: 100 # Sets the maximum tempereature for eddys tempereature sensor to operate

#[probe_eddy_current btt_eddy]
#sensor_type: ldc1612
#z_offset: 2.5
#i2c_mcu: eddy  # This value is good for the Eddy USB but would need to be adjusted for the Eddy Coil according to the MCU you have used.
#i2c_bus: i2c0f # This value is good for the Eddy USB but would need to be adjusted for the Eddy Coil according to the I2C bus you have used.
# Measure the offsets below using the method described here: https://www.klipper3d.org/Probe_Calibrate.html#calibrating-probe-x-and-y-offsets
#x_offset: -32.818
#y_offset: -22.787

#[temperature_probe btt_eddy]
#sensor_type: Generic 3950
#sensor_pin: eddy:gpio26
#horizontal_move_z: 2

#[bed_mesh]
#horizontal_move_z: 2
#speed: 200
#mesh_min: 15, 15
#mesh_max: 147, 157
#probe_count: 9, 9
#algorithm: bicubic
###scan_overshoot: 8  #uncomment this section if you still have room left over on the X axis for some scan overshoot to product smoother movements and more accurate scanning. Uncommenting this should be fine if you are using a standard voron mount.

#[safe_z_home]
#home_xy_position: 90, 90 # Choose an X,Y position that is in the center of your bed. For a 300x300 machine that will be 150, 150. Use the same principle to calculate your bed center.
#z_hop: 10
#z_hop_speed: 15 #25
#speed: 50 #200

#[save_variables]
#filename: ~/printer_data/config/variables.cfg


#------------------------------------------------ HEATER BED ------------------------------------------------
# The heated bed configuration
#------------------------------------------------------------------------------------------------------------
[heater_bed]
#control: pid
#pid_kp: 68.203
#pid_ki: 2.842
#pid_kd: 409.216
max_power: 0.8

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe]
#*# z_offset = 0.300
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 21.802
#*# pid_ki = 1.191
#*# pid_kd = 99.742
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 48.482
#*# pid_ki = 1.525
#*# pid_kd = 385.430
#*#
#*# [input_shaper]
#*# shaper_type_x = ei
#*# shaper_freq_x = 72.6
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.043125, -0.029063, -0.040625, -0.044688, -0.038438
#*# 	  -0.020000, -0.014063, -0.017500, -0.028438, -0.028125
#*# 	  -0.004375, -0.005000, -0.006563, -0.020625, -0.029688
#*# 	  -0.011250, -0.011563, -0.016563, -0.048750, -0.059688
#*# 	  0.013125, 0.015000, 0.011562, -0.007500, -0.034063
#*# x_count = 5
#*# y_count = 5
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 15.0
#*# max_x = 150.0
#*# min_y = 15.0
#*# max_y = 160.0
